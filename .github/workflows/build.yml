name: Build PS2 ELF

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Opcional) Generar assets RAW desde PNG.
      # Déjalo en false si ya tienes tus .raw listos en el repo.
      - name: Generate RAW assets (optional)
        if: false
        run: |
          python -m pip install --upgrade pip
          pip install pillow
          python tools/png2rgba5551.py assets_src/bg.png assets_build/bg.raw
          python tools/png2rgba5551.py assets_src/disc.png assets_build/disc.raw

      - name: Build inside ps2dev Docker (install make if missing)
        run: |
          docker pull ps2dev/ps2dev:v1.2.0
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            ps2dev/ps2dev:v1.2.0 \
            /bin/sh -c '
              set -e

              # Instalar "make" según el sistema base del contenedor:
              if command -v make >/dev/null 2>&1; then
                echo "make already present"
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache make
              elif command -v apt-get >/dev/null 2>&1; then
                apt-get update
                apt-get install -y make
              elif command -v yum >/dev/null 2>&1; then
                yum install -y make
              else
                echo "No package manager found to install make"
                exit 1
              fi

              make clean
              make -j2
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ps2-elf
          path: |
            *.elf
            *.ELF
            bin/**/*.elf
            bin/**/*.ELF
