name: Build PS2 ELF

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in container (install deps + build PS2SDK + assets + ELF)
        run: |
          docker pull ps2dev/ps2dev:v1.2.0
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            ps2dev/ps2dev:v1.2.0 \
            /bin/sh -c '
              set -e

              # --- Base deps (Alpine) ---
              # Necesitamos: make, git, python + pip para Pillow, y build tools para ps2sdk/gsKit
              apk add --no-cache \
                make git \
                python3 py3-pip \
                build-base cmake \
                zlib-dev

              pip3 install --no-cache-dir pillow

              # --- Ensure PS2SDK present + build it ---
              # La imagen tiene /usr/local/ps2dev normalmente. Si no, lo creamos.
              export PS2DEV=/usr/local/ps2dev
              export PS2SDK=$PS2DEV/ps2sdk

              mkdir -p "$PS2DEV"
              if [ ! -d "$PS2SDK/.git" ]; then
                git clone --depth 1 https://github.com/ps2dev/ps2sdk.git "$PS2SDK"
              fi

              cd "$PS2SDK"
              make -j2
              make install

              # --- Build gsKit + dmaKit (headers que te faltan) ---
              # Est√°n en ps2sdk/ports
              cd "$PS2SDK/ports"
              make -j2
              make install

              # --- Back to project ---
              cd /src

              # --- Generate RAW assets from PNGs (SIEMPRE) ---
              python3 tools/build_assets.py

              # --- Build ELF ---
              make clean
              make -j2
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhui-elf
          path: nhui.elf
