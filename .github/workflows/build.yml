name: Build PS2 ELF

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in container (ports + assets + ELF)
        run: |
          docker pull ps2dev/ps2dev:v1.2.0
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            ps2dev/ps2dev:v1.2.0 \
            /bin/sh -c '
              set -e

              # --- Paquetes necesarios (sin pip) ---
              apk add --no-cache \
                make git \
                python3 py3-pillow \
                build-base cmake zlib-dev

              # --- Variables PS2DEV / PS2SDK (ya existen en la imagen) ---
              export PS2DEV=/usr/local/ps2dev
              export PS2SDK=$PS2DEV/ps2sdk

              # --- Instalar PORTS (gsKit/dmaKit vienen de aquí) ---
              if [ -d "$PS2SDK/ports" ]; then
                cd "$PS2SDK/ports"
                make -j2
                make install
              else
                echo "No existe $PS2SDK/ports (PS2SDK incompleto en la imagen)"
                exit 1
              fi

              # --- Volver al proyecto y generar assets RAW ---
              cd /src
              mkdir -p assets_build

              # Si tienes tools/build_assets.py úsalo; si no, usa png2rgba5551.py
              if [ -f tools/build_assets.py ]; then
                python3 tools/build_assets.py
              elif [ -f tools/png2rgba5551.py ]; then
                BG_PNG=$(ls assets_src/*bg*.png 2>/dev/null | head -n1)
                DISC_PNG=$(ls assets_src/*disc*.png assets_src/*icon*.png 2>/dev/null | head -n1)

                # Fallback si los nombres no coinciden
                [ -n "$BG_PNG" ] || BG_PNG=$(ls assets_src/*.png 2>/dev/null | head -n1)
                [ -n "$DISC_PNG" ] || DISC_PNG=$(ls assets_src/*.png 2>/dev/null | tail -n1)

                echo "BG_PNG=$BG_PNG"
                echo "DISC_PNG=$DISC_PNG"

                python3 tools/png2rgba5551.py "$BG_PNG" assets_build/bg.raw
                python3 tools/png2rgba5551.py "$DISC_PNG" assets_build/disc.raw
              else
                echo "No encuentro tools/build_assets.py ni tools/png2rgba5551.py"
                exit 1
              fi

              # --- Compilar tu ELF ---
              make clean
              make -j2
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nhui-elf
          path: |
            nhui.elf
            *.elf
            *.ELF
