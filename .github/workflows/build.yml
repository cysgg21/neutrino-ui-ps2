name: Build PS2 ELF

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Generación de assets RAW (OPCIONAL).
      # Déjalo en false si YA tienes assets_build/bg.raw y assets_build/disc.raw en el repo.
      - name: Generate RAW assets (optional)
        if: false
        run: |
          python -m pip install --upgrade pip
          pip install pillow
          python tools/png2rgba5551.py assets_src/bg.png assets_build/bg.raw
          python tools/png2rgba5551.py assets_src/disc.png assets_build/disc.raw

      - name: Build inside ps2dev Docker (fast + stable)
        run: |
          docker pull ps2dev/ps2dev:v1.2.0
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            ps2dev/ps2dev:v1.2.0 \
            /bin/sh -c "make clean && make -j2"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ps2-elf
          path: |
            *.elf
            *.ELF
            bin/**/*.elf
            bin/**/*.ELF
