name: build-ps2-elf

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential cmake make \
            python3 python3-pip \
            wget curl patch \
            texinfo flex bison gawk \
            libgmp-dev libmpfr-dev libmpc-dev \
            libncurses-dev zlib1g-dev
          python3 -m pip install pillow

      - name: Install PS2DEV toolchain + PS2SDK
        run: |
          export PS2DEV=$HOME/ps2dev
          echo "PS2DEV=$PS2DEV" >> $GITHUB_ENV
          echo "$PS2DEV/bin" >> $GITHUB_PATH

          git clone --depth 1 https://github.com/ps2dev/ps2toolchain.git
          cd ps2toolchain
          ./toolchain.sh
          cd ..

          git clone --depth 1 https://github.com/ps2dev/ps2sdk.git
          export PS2SDK=$PS2DEV/ps2sdk
          echo "PS2SDK=$PS2SDK" >> $GITHUB_ENV
          cd ps2sdk
          make -j2
          make install
          cd ..

      - name: Build assets (png -> raw)
        run: |
          python3 tools/build_assets.py

      - name: Build ELF
        run: |
          make clean
          make

      - name: Upload nhui.elf
        uses: actions/upload-artifact@v4
        with:
          name: nhui-elf
          path: nhui.elf
