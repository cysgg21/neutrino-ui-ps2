name: build-ps2-elf

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in ps2dev docker (includes gsKit)
        run: |
          set -e
          docker pull ps2dev/ps2dev:v1.2.0

          docker run --rm \
            -v "$PWD":/src \
            -w /src \
            ps2dev/ps2dev:v1.2.0 \
            sh -lc '
              set -e
              apk add --no-cache make git python3 py3-pillow cmake

              export PS2DEV=/usr/local/ps2dev
              export PS2SDK=$PS2DEV/ps2sdk
              export PATH="$PS2DEV/bin:$PATH"

              # install gsKit
              git clone --depth 1 https://github.com/ps2dev/gsKit.git /tmp/gsKit
              cd /tmp/gsKit
              make -j2
              make install

              cd /src
              python3 tools/build_assets.py
              make clean
              make
            '

      - name: Upload nhui.elf
        uses: actions/upload-artifact@v4
        with:
          name: nhui-elf
          path: nhui.elf
