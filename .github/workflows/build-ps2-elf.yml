name: build-ps2-elf

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build nhui.elf in ps2dev container
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          docker pull ps2dev/ps2dev:v1.2.0

          docker run --rm \
            -e GH_TOKEN="$GH_TOKEN" \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            ps2dev/ps2dev:v1.2.0 \
            /bin/sh -lc '
              set -e

              # Alpine deps
              apk add --no-cache make git python3 py3-pillow build-base cmake

              # PS2SDK env (por si no viene seteado)
              export PS2DEV=${PS2DEV:-/usr/local/ps2dev}
              export PS2SDK=${PS2SDK:-$PS2DEV/ps2sdk}

              echo "PS2DEV=$PS2DEV"
              echo "PS2SDK=$PS2SDK"

              # Evita el error "could not read Username..." usando token
              git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

              # Instala PORTS si faltan headers
              if [ ! -f "$PS2SDK/ports/include/gsKit.h" ] || [ ! -f "$PS2SDK/ports/include/dmaKit.h" ]; then
                rm -rf /tmp/dmaKit /tmp/gsKit

                git clone --depth 1 https://github.com/ps2dev/dmaKit.git /tmp/dmaKit
                make -C /tmp/dmaKit -j2 install

                git clone --depth 1 https://github.com/ps2dev/gsKit.git /tmp/gsKit
                make -C /tmp/gsKit -j2 install
              fi

              # Genera assets_build/*.raw
              python3 tools/build_assets.py

              # Build ELF
              make clean
              make
            '

      - name: Upload nhui.elf
        uses: actions/upload-artifact@v4
        with:
          name: nhui-elf
          path: nhui.elf
